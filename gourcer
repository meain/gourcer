#!/bin/bash

set -e # stop on first error

rm -f /results/{gource.ppm,gource.mp4}
RES="${RES:-1280x720}"
DEPTH="${DEPTH:-24}"

screen -dmS recording xvfb-run -a -s "-screen 0 ${RES}x${DEPTH}" \ 
    gource -s 0.2 -a 1 ./ "$RES" -o - | \
    ffmpeg -y -r 60 -f image2pipe -vcodec ppm -i - -vcodec libx264 \
    -preset ultrafast -pix_fmt yuv420p -crf 1 \
    -analyzeduration 999999999 -probesize 999999999 -threads 0 -bf 0 /results/gource.mp4

# This hack is needed because gource process doesn't stop
lastsize="0"
filesize="0"
while [[ "$filesize" -eq "0" || $lastsize -lt $filesize ]] ;
do
    sleep 20
    lastsize="$filesize"
    filesize=$(stat -c '%s' /results/gource.mp4)
    echo 'Polling the size. Current size is' $filesize
done
echo 'Force stopping recording because file size is not growing'
screen -S recording -X quit
