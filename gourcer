#!/bin/bash
set -e # stop on first error

rm -f /results/{gource.ppm,gource.mp4}
RES="${RES:-1280x720}"
DEPTH="${DEPTH:-24}"

xvfb-run -a -s "-screen 0 ${RES}x${DEPTH}" /tmp/qg &

# This hack is needed because gource process doesn't stop
lastsize="0"
filesize="0"
while [[ "$filesize" -eq "0" || $lastsize -lt $filesize ]] ;
do
    sleep 20
    lastsize="$filesize"
    filesize=$(stat -c '%s' /results/gource.mp4)
    echo 'Polling the size. Current size is' $filesize
done
echo 'Force stopping recording because file size is not growing'
exit 0
