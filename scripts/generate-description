#!/bin/sh

set -e

# Get repository info
REPO_URL=$(cat repo)
AUTHOR=$(echo "$REPO_URL" | sed 's|https://[^/]*/\([^/]*\)/.*|\1|')
REPO_NAME=$(echo "$REPO_URL" | sed 's|.*/\([^/]*\)$|\1|')

echo "ðŸš€ Watch the development journey of $REPO_NAME by $AUTHOR!"
echo ""

if echo "$REPO_URL" | grep -q '//github.com/'; then
    # Get GitHub API data
    API_URL=$(echo "$REPO_URL" | sed 's|github.com|api.github.com/repos|')
    curl -s "$API_URL" > /tmp/gh-repo-page

    DESCRIPTION=$(jq -r '.description // "No description available"' /tmp/gh-repo-page)
    STARS=$(jq -r '.watchers // 0' /tmp/gh-repo-page)
    FORKS=$(jq -r '.forks // 0' /tmp/gh-repo-page)

    echo "ðŸ“ $DESCRIPTION"
    echo ""
    echo "â­ $STARS stars | ðŸ´ $FORKS forks"
    echo ""
fi

cd crepo || exit 1

TOTAL_COMMITS=$(git rev-list --count HEAD)
FIRST_COMMIT_DATE=$(git log --oneline | tail -1 | awk '{print $1}' | xargs git show --format="%ci" | head -1 | cut -d' ' -f1)
TOTAL_FILES=$(find . -type f | grep -v '.git/' | wc -l | tr -d ' ')
TOTAL_LINES=$(find . -type f | grep -v '.git/' | xargs cat 2>/dev/null | wc -l | tr -d ' ')

echo "ðŸ“Š Project Stats:"
echo "â€¢ $TOTAL_COMMITS commits since $FIRST_COMMIT_DATE"
echo "â€¢ $TOTAL_FILES files with $TOTAL_LINES lines of code"
echo ""
echo "ðŸŽ¬ This visualization shows the entire development history using Gource!"
echo "Learn more about Gource: https://gource.io/"
echo ""
echo "ðŸ”— Repository: $REPO_URL"
echo ""
echo "#programming #coding #opensource #gource #visualization #github"
